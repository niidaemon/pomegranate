; ===================================================================
; PgBouncer Configuration
; ===================================================================
; Purpose:
;   Connection pooling for PostgreSQL microservices.
;   This configuration defines database mappings and pooling behavior.
; ===================================================================

[databases]
; -------------------------------------------------------------------
; Database connection definitions
; Each entry maps a logical database name (used by clients) to the
; actual backend connection parameters (host, port, dbname).
; -------------------------------------------------------------------

auth_db              = host=haproxy port=5432 dbname=auth_db
catalog_db           = host=haproxy port=5432 dbname=catalog_db
cart_db              = host=haproxy port=5432 dbname=cart_db
orders_db            = host=haproxy port=5432 dbname=orders_db
inventory_db         = host=haproxy port=5432 dbname=inventory_db
payments_db          = host=haproxy port=5432 dbname=payments_db
analytics_db         = host=haproxy port=5432 dbname=analytics_db

; Read-only connections (pointing to standby/replica via HAProxy)
auth_db_readonly     = host=haproxy port=5433 dbname=auth_db
catalog_db_readonly  = host=haproxy port=5433 dbname=catalog_db


[pgbouncer]
; -------------------------------------------------------------------
; PgBouncer settings
; -------------------------------------------------------------------

; Pooling mode: transaction-level pooling is safest for most apps
pool_mode = transaction

; Listening interface and port
listen_addr = 0.0.0.0
listen_port = 6432

; Authentication settings
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

; Connection limits
max_client_conn   = ${PGBOUNCER_MAX_CLIENT_CONN}  ; total client connections allowed
default_pool_size = ${PGBOUNCER_POOL_SIZE}        ; per-database pool size
min_pool_size     = 10                            ; keep at least this many connections ready
reserve_pool_size = 5                             ; extra connections for spikes
max_db_connections = 100                          ; cap per-database connections

; Timeouts
server_idle_timeout = 600   ; close server connections after 10 minutes idle

; Logging
log_connections    = 1
log_disconnections = 1

; ===================================================================
; End of PgBouncer Configuration
; ===================================================================
