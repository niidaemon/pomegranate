# ===================================================================
# HAProxy Configuration
# ===================================================================
# Purpose:
#   Load balancing and routing for PostgreSQL primary and standby nodes.
#   - Port 5432: routes to the primary (with standby backups)
#   - Port 5433: routes to replicas for read-only queries
#   - Port 8404: exposes HAProxy stats dashboard
# ===================================================================

# -----------------------------
# GLOBAL SETTINGS
# -----------------------------
global
    log stdout format raw local0        # Log to stdout for containerized environments
    maxconn 4096                        # Maximum concurrent connections
    user haproxy
    group haproxy

# -----------------------------
# DEFAULT SETTINGS
# -----------------------------
defaults
    log     global
    mode    tcp                         # TCP mode for PostgreSQL traffic
    timeout connect 10s
    timeout client  1h
    timeout server  1h
    retries 3

# -----------------------------
# STATS INTERFACE
# -----------------------------
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 30s

# -----------------------------
# FRONTEND: PRIMARY
# -----------------------------
frontend postgres_primary
    bind *:5432                         # Client connections to primary DB
    default_backend postgres_primary_backend

# -----------------------------
# BACKEND: PRIMARY
# -----------------------------
backend postgres_primary_backend
    balance roundrobin                  # Distribute connections evenly
    option pgsql-check user replicator  # Health check using PostgreSQL protocol
    server primary  postgres-primary:5432  check inter 3s rise 2 fall 3
    server standby1 postgres-standby-1:5432 check inter 3s rise 2 fall 3 backup
    server standby2 postgres-standby-2:5432 check inter 3s rise 2 fall 3 backup

# -----------------------------
# FRONTEND: REPLICAS
# -----------------------------
frontend postgres_replicas
    bind *:5433                         # Client connections for read-only queries
    default_backend postgres_replicas_backend

# -----------------------------
# BACKEND: REPLICAS
# -----------------------------
backend postgres_replicas_backend
    balance roundrobin
    option pgsql-check user replicator  # Health check using PostgreSQL protocol
    server standby1 postgres-standby-1:5432 check inter 3s rise 2 fall 3
    server standby2 postgres-standby-2:5432 check inter 3s rise 2 fall 3
    server primary  postgres-primary:5432  check inter 3s rise 2 fall 3 backup

# ===================================================================
# End of HAProxy Configuration
# ===================================================================
